trigger:
- master
  
variables:
  buildConfiguration: 'Release'

jobs:
# Build once
- job: build
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - task: DotNetCoreCLI@2
    inputs:
      command: build
      configuration: $(buildConfiguration)
  # Publish entire working directory to artifacts - https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=vsts&tabs=yaml#artifact-download
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)'
      artifactName: builtProject
# Test on linux, macOS and windows
- job: test_linux
  pool:
    vmImage: 'Ubuntu 16.04'
  dependsOn: build
  steps:
  - template: azure-test.yml
- job: test_windows
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - template: azure-test.yml
- job: test_macos
  pool:
    vmImage: 'macOS-10.13'
  steps:
  - template: azure-test.yml
- job: Windows
  dependsOn:
  - test_linux
  - test_windows
  - test_macos
  steps:
  # Download entire working directory from artifacts
  # If changelog has changed
    # Get changelog latest version
    # Get latest tag
    # If versions are different, push to nuget and tag
    # Pack working dir (dont rebuild)
    # Publish to nuget.org
  # If changelog has not changed
    # Publish 1.0.0-<branch name>.<date etc (increasing num)> to myget
  - script: echo deploy